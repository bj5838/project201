#include <string.h>
#include <winsock2.h>
#include "parse.h"
#include "LinkedList.h"

void testFun(void) {
	__asm jmp esp
}

void addNull(char* cmd) {
	for (int i = 0; i < 500; i++) {
		if (cmd[i] == '\n') {
			cmd[i] = '\0';
			break;
		}
	}
}

//-1 = ERROR> upload takes 2 arguments
//-2 = ERROR> 1st arg must be 'local' or 'remote'
//-3 = ERROR> 2nd argument must be 'files', 'path', or 'folders'
//-4 = ERROR> command takes no arguments
//-5 = ERROR> Invalid command
//-6 = Error> Invalid character


int isASCII(char* rawInput) {
	char cmdToParse[500];
	int len;
	int ascii=0;
	strcpy(cmdToParse, rawInput);
	len = strlen(cmdToParse);
	for (int i = 0; i < len; i++) {
		ascii = (int)cmdToParse[i];
		if (ascii > 255 || ascii < 0) return 0;
	}
	return 1;

}

int parseCommand(char* rawCommand, struct LinkedList* CommandHistory, SOCKET* clientSock) {
	SOCKET clientConn = *clientSock;
	char successValidated[] = "Command history integrity validated\n";
	char success[] = "Command completed\n";
	char commandToParse[1000];
	char* firstPart;
	char* secondPart;
	char* thirdPart;
	
	if (isASCII(rawCommand)==0) {
		return -6;
	}
	strcpy(commandToParse, rawCommand);

	firstPart = strtok(commandToParse, " ");
	secondPart = strtok(NULL, " ");
	thirdPart = strtok(NULL, " ");
	


	if (strcmp(firstPart, "upload") == 0) {
		if (secondPart == NULL || thirdPart == NULL) {
			printf("ERROR> command provided takes 2 arguments\n");
			return -1;
		}
		printf("Sending upload success message\n");
		send(clientConn, success, sizeof(success), 0);
	}
	else if (strcmp(firstPart, "done") == 0) {
		return 0;
	}
	else if (strcmp(firstPart, "download") == 0) {
		if (secondPart == NULL || thirdPart == NULL) {
			printf("ERROR> command provided takes 2 arguments\n");
			return -1;
		}
		printf("Sending download success message\n");
		send(clientConn, success, sizeof(success), 0);
	}
	else if (strcmp(firstPart, "delete") == 0) {
		if (secondPart == NULL || thirdPart == NULL) {
			printf("ERROR> command provided takes 2 arguments\n");
			return -1;
		}
		else if (strcmp(secondPart, "local") == 0) {

			send(clientConn, success, sizeof(success), 0);
		}
		else if (strcmp(secondPart, "remote") == 0) {

			send(clientConn, success, sizeof(success), 0);
		}
		else {
			printf("ERROR> 1st arg to command must be 'local' or 'remote'\n", firstPart);
			return -2;
		}
	}
	else if (strcmp(firstPart, "change") == 0) {
		if (secondPart == NULL || thirdPart == NULL) {
			printf("ERROR> command provided takes 2 arguments\n");
			return -1;
		} 
		else if (strcmp(secondPart, "local") == 0) {
			send(clientConn, success, sizeof(success), 0);
		}
		else if (strcmp(secondPart, "remote") == 0) {

			send(clientConn, success, sizeof(success), 0);
		}
		else {
			printf("ERROR> 1st arg to command must be 'local' or 'remote'\n", firstPart);
			return -2;
		}
	}
	else if (strcmp(firstPart, "show") == 0) {
		if (secondPart == NULL || thirdPart == NULL) {
			printf("ERROR> command provided takes 2 arguments\n");
			return -1;
		}
		else if (strcmp(secondPart, "local") == 0) {
			if (strcmp(thirdPart, "files") == 0) {

				send(clientConn, success, sizeof(success), 0);
			}
			else if (strcmp(thirdPart, "path") == 0) {

				send(clientConn, success, sizeof(success), 0);
			}
			else if (strcmp(thirdPart, "folders") == 0) {

				send(clientConn, success, sizeof(success), 0);
			}
			else {
				printf("ERROR> 2nd argument to command must be 'files', 'path', or 'folders'\n");
				return -3;
			}
		}
		else if (strcmp(secondPart, "remote") == 0) {
			if (secondPart == NULL || thirdPart == NULL) {
				printf("ERROR> command provided takes 2 arguments\n");
				return -1;
			}
			if (strcmp(thirdPart, "files") == 0) {

				send(clientConn, success, sizeof(success), 0);
			}
			else if (strcmp(thirdPart, "path") == 0) {

				send(clientConn, success, sizeof(success), 0);
			}
			else if (strcmp(thirdPart, "folders") == 0) {

				send(clientConn, success, sizeof(success), 0);
			}
			else {
				printf("ERROR> 2nd argument to command must be 'files', 'path', or 'folders'\n");
				return -3;
			}
		}
		else {
			printf("ERROR> 1st arg to command must be 'local' or 'remote'\n", firstPart);
			return -2;
		}
	}
	else if (strcmp(firstPart, "history") == 0) {
		if (secondPart == NULL & thirdPart == NULL) {
			printList(CommandHistory, &clientConn);
		}
		else {
			printf("ERROR> command provided takes no arguments\n");
			return -4;
		}
	}
	else if (strcmp(firstPart, "validate") == 0) {
		if (secondPart == NULL & thirdPart == NULL) {
			if (validate(CommandHistory, &clientConn)) {
				printf("Command history integrity validated\n");
				send(clientConn, successValidated, sizeof(successValidated), 0);
			}
		}
		else {
			printf("ERROR> command provided takes no arguments\n");
			return -4;
		}
	}
	else {
		printf("ERROR> Invalid command\n", firstPart);
		return -5;
	}

	return 1;
}